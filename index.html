<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Toastmasters Timer â€” FTH Ready</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cg fill='none'%3E%3Ccircle cx='32' cy='32' r='30' stroke='%23004165' stroke-width='4'/%3E%3Cpath d='M32 14v18l10 6' stroke='%23ff0000' stroke-width='5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/g%3E%3C/svg%3E">
<style>
  :root{
    --tm-maroon:#772432; --tm-blue:#004165;
    --tm-gray:#A9B2B1;  --tm-yellow:#F2DF74;
    --white:#fff; --black:#111;
    --green: rgba(0,200,0,.50);
    --yellow: rgba(255,215,0,.60);
    --red: rgba(255,0,0,.50);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;color:var(--black);background:#fafbfc}
  header{
    background:linear-gradient(90deg,var(--tm-blue),var(--tm-maroon));
    color:#fff; padding:12px 16px; display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    box-shadow:0 2px 10px rgba(0,0,0,.15)
  }
  .brand{display:flex;align-items:center;gap:10px;font-weight:800}
  .badge{width:34px;height:34px;border-radius:50%;display:grid;place-items:center;background:var(--tm-yellow);color:#222;font-weight:900}
  .btn{appearance:none;border:0;border-radius:12px;padding:9px 12px;font-weight:700;cursor:pointer;background:#fff;color:#222;box-shadow:0 2px 6px rgba(0,0,0,.12)}
  .btn[disabled]{opacity:.5;cursor:not-allowed;filter:grayscale(20%)}
  .btn.primary{background:var(--tm-yellow)}
  main{max-width:1120px;margin:18px auto;padding:0 14px;display:grid;gap:16px}
  .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
  @media (max-width: 980px){.grid{grid-template-columns:1fr}}
  .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08);overflow:hidden}
  .face{position:relative;min-height:360px;display:grid;place-items:center;background:#f3f6f9;overflow:hidden}
  .square{
    position:absolute;top:50%;left:50%;
    width:min(90%,520px);height:auto;aspect-ratio:1/1;
    transform:translate(-50%,-50%);
    border-radius:18px;background:transparent;transition:background-color .28s ease;
    pointer-events:none;
  }
  .digits{position:relative;font-weight:900;letter-spacing:1px;font-size:clamp(3rem,10vw,7.4rem);text-shadow:0 2px 0 rgba(255,255,255,.85);user-select:none}
  .chip{position:absolute;right:12px;top:12px;background:rgba(255,255,255,.92);border-radius:999px;padding:6px 10px;font-weight:800;box-shadow:0 2px 8px rgba(0,0,0,.12)}
  .panel{padding:14px;border-top:4px solid var(--tm-blue);display:grid;gap:12px}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .row.buttons{justify-content:flex-start; gap:10px}
  /* flex helper to push right-aligned items */
  .grow{ flex:1 }
  .righty{ display:flex; gap:8px; align-items:center; margin-left:auto }
  .righty input{ padding:9px 10px; border:1px solid #d5dbe3; border-radius:10px; min-width:120px }
  /* print-only meta line */
  .print-only{ display:none }
  label{font-weight:800}
  input[type='text'], select{padding:9px 10px;border:1px solid #d5dbe3;border-radius:10px;min-width:120px}
  input[disabled]{background:#f3f3f3;color:#666}
  .err{color:#b00020;font-size:.9rem}
  .kbd{display:inline-block;border:1px solid #d0d4da;border-bottom-width:2px;border-radius:6px;padding:2px 6px;font-family:ui-monospace,Consolas,Menlo,monospace}
  .help{font-size:.92rem;color:#444;background:#f6f7f9;border-left:4px solid var(--tm-maroon);padding:10px;border-radius:8px}
  .qual{font-size:.92rem;color:#222;background:#fffbe6;border-left:4px solid var(--tm-yellow);padding:8px 10px;border-radius:8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #e8ecf1;text-align:left}
  th{background:#f1f4f8}
  .q-badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;cursor:pointer}
  .q-yes{background:var(--yellow);color:#222}
  .q-no{background:rgba(255,0,0,.18);color:#b00000;border:1px solid #f3b3b3}

  /* PRINT: show ONLY the Recorded Times table */
  @media print{
    @page { margin: 10mm }
    html, body { height: auto; background:#fff }
    header, .help, .qual, .row.buttons, .timerWrap, .grid > *:not(.recordsWrap) { display:none !important }
    .recordsWrap{ display:block !important; box-shadow:none !important; border:0 !important; }
    .recordsWrap .panel{ border:0 !important; }
    table, thead, tbody, tr, td, th { page-break-inside: avoid !important; break-inside: avoid !important }
    /* hide helper text in print */
    .muted{ display:none !important }
    /* show print-only line */
    .print-only{ display:block !important; margin: 6px 0; font-weight:700 }
  }
</style>
</head>
<body>
  <header>
    <div class="brand"><div class="badge">TM</div><div>Toastmasters Timer</div></div>
  </header>

  <main>
    <div class="grid">
      <section class="card timerWrap" id="tm-focus" tabindex="0" aria-label="Timer">
        <div class="face" id="face">
          <div class="square" id="square"></div>
          <div class="chip" id="status">Ready</div>
          <div class="digits" id="digits">00:00</div>
        </div>

        <div class="panel">
          <div class="row buttons">
            <button id="reset" class="btn" title="R">Reset</button>
            <button id="start" class="btn primary" title="Space" disabled>Start</button>
            <button id="btn-print" class="btn" title="Export to PDF">Export PDF</button>

            <!-- Flexible spacer pushes inputs to the right -->
            <div class="grow"></div>

            <!-- Right-aligned inputs for club number and date -->
            <div class="righty">
              <label for="clubNo">Club No.</label>
              <input id="clubNo" type="text" inputmode="numeric" pattern="\d*" placeholder="4039" maxlength="11" title="Digits only (max 11)"/>

              <label for="meetingDate">Meeting Date</label>
              <input id="meetingDate" type="date" title="Pick meeting date"/>
              <span class="hint" id="dateHint"></span>
            </div>
          </div>

          <div class="row">
            <label>Speaker Name</label>
            <input id="speaker" type="text" placeholder="e.g., Jane Doe" autocomplete="off"/>
            <button id="mark" class="btn" title="Mark a split">Mark</button>
            <button id="addRecord" class="btn" title="Add to table">Add Record</button>
          </div>

          <div class="row">
            <label for="preset">Preset</label>
            <select id="preset">
              <option value="TT">Table Topics 1-2</option>
              <option value="EV">Evaluation 2-3</option>
              <option value="IB">Ice Breaker 4-6</option>
              <option value="S57">Speech 5-7</option>
              <option value="CUST">Custom</option>
            </select>
            <label>Green</label><input id="gMin" type="text" value="01:00" disabled title="Set by preset"/>
            <label>Yellow</label><input id="yMin" type="text" value="01:30" disabled title="Set by preset"/>
            <label>Red</label><input id="rMin" type="text" value="02:00" disabled title="Set by preset"/>
          </div>

          <div id="qualWindow" class="qual">Qualifies: 00:30 â€“ 02:30</div>
          <div id="err" class="err" style="display:none"></div>
        </div>
      </section>

      <section class="card recordsWrap">
        <div class="panel">
          <div class="row"><strong>Recorded Times</strong> <span class="muted">(click the badge to toggle Qualified)</span></div>
          <!-- Print-only meta line: shows club number and meeting date on PDF -->
          <div class="print-only" id="printMeta">
            Club # <span id="pClub">4039</span>, Date <span id="pDate">Sept 07</span>
          </div>
          <table id="records">
            <thead><tr><th>#</th><th>Speaker</th><th>Speech Type</th><th>Time</th><th>Qualified</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const toSec = mmss => { const mss=(mmss||'0:00').split(':'); if(mss.length!==2) return NaN; const m=Number(mss[0]), s=Number(mss[1]); if(!Number.isFinite(m)||!Number.isFinite(s)) return NaN; return m*60 + s; };
  const toMMSS = s  => { s=Math.max(0,Math.round(s)); const m=Math.floor(s/60), t=s%60; return (m<10?'0':'')+m+':'+(t<10?'0':'')+t; };

  const digits=$('digits'), square=$('square'), status=$('status'),
        gEl=$('gMin'), yEl=$('yMin'), rEl=$('rMin'),
        presetEl=$('preset'), startBtn=$('start'),
        markBtn=$('mark'), addBtn=$('addRecord'), speakerEl=$('speaker'),
        qualDiv=$('qualWindow'), errDiv=$('err');

  const recordsTbody = $('records').querySelector('tbody');

  // New elements for club number and meeting date inputs and print meta
  const clubNoEl = document.getElementById('clubNo');
  const dateEl   = document.getElementById('meetingDate');
  const dateHint = document.getElementById('dateHint');
  const pClub    = document.getElementById('pClub');
  const pDate    = document.getElementById('pDate');

  // Month labels for short display (Sept instead of Sep for 9th month)
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sept','Oct','Nov','Dec'];
  function padNum(n){ return n<10 ? '0'+n : ''+n; }
  function fmtShort(iso){ const d = new Date(iso); if(!iso||isNaN(d.getTime())) return ''; return months[d.getMonth()] + ' ' + padNum(d.getDate()); }
  function todayISO(){ const d=new Date(); const m=padNum(d.getMonth()+1); const dy=padNum(d.getDate()); return d.getFullYear()+'-'+m+'-'+dy; }

  let running=false, startTs=0, acc=0, raf=0, laps=[];

  const PRESETS = {
    TT:  { g:'01:00', y:'01:30', r:'02:00', label:'Table Topics 1-2' },
    EV:  { g:'02:00', y:'02:30', r:'03:00', label:'Evaluation 2-3' },
    IB:  { g:'04:00', y:'05:00', r:'06:00', label:'Ice Breaker 4-6' },
    S57: { g:'05:00', y:'06:00', r:'07:00', label:'Speech 5-7' },
    CUST:{ g:'01:00', y:'01:30', r:'02:00', label:'Custom' }
  };

  function updateStartEnabled(){
    const okName = (speakerEl.value||'').trim().length>0;
    const okTimes = validateTimes(presetEl.value==='CUST');
    startBtn.disabled = !(okName && okTimes);
  }

  function savePrefs(){
    localStorage.setItem('tm_timer_prefs', JSON.stringify({
      preset: presetEl.value,
      g: gEl.value,
      y: yEl.value,
      r: rEl.value,
      clubNo: clubNoEl.value,
      meetingDate: dateEl.value
    }));
  }
  function loadPrefs(){
    try{
      const p=JSON.parse(localStorage.getItem('tm_timer_prefs')||'{}');
      if(p.preset && PRESETS[p.preset]) presetEl.value=p.preset;
      if(p.preset==='CUST' && p.g && p.y && p.r){ gEl.value=p.g; yEl.value=p.y; rEl.value=p.r; }
      // load club number and meeting date
      if(p.clubNo) clubNoEl.value = String(p.clubNo).replace(/\D/g,'').slice(0,11);
      if(p.meetingDate) dateEl.value = p.meetingDate;
    }catch(e){}
    applyPreset(presetEl.value, true);
  }

  function setEditable(edit){
    [gEl,yEl,rEl].forEach(el=>{ el.disabled=!edit; el.title = edit ? 'mm:ss' : 'Set by preset'; });
  }

  function applyPreset(code, onLoad=false){
    const pre = PRESETS[code] || PRESETS.TT;
    if(code!=='CUST'){
      gEl.value = pre.g; yEl.value = pre.y; rEl.value = pre.r;
      setEditable(false);
    } else {
      setEditable(true);
    }
    updateQualWindow();
    if(!onLoad) savePrefs();
    paint(0);
    validateTimes(code==='CUST');
    updateStartEnabled();
  }

  function thresholds(){
    return { g:toSec(gEl.value), y:toSec(yEl.value), r:toSec(rEl.value) };
  }

  function updateQualWindow(){
    const t = thresholds();
    if(Number.isNaN(t.g)||Number.isNaN(t.r)){ qualDiv.textContent = 'Qualifies: --:-- - --:--'; return; }
    const lower = Math.max(0, t.g - 30);
    const upper = t.r + 30;
    qualDiv.textContent = 'Qualifies: ' + toMMSS(lower) + ' - ' + toMMSS(upper);
  }

  function now(){ return performance.now(); }
  function curSec(){ const ms = running ? (acc+(now()-startTs)) : acc; return Math.floor(ms/1000); }

  function reallyStart(){
    running=true; startTs=now();
    status.textContent='Running'; startBtn.textContent='Pause';
    tick();
  }
  function startOrPause(){
    if(startBtn.disabled){
      alert('Please enter the Speaker Name and valid Custom timings (if Custom) before starting.');
      return;
    }
    if(running){ pause(); } else { reallyStart(); }
  }
  function pause(){
    if(!running) return;
    running=false; acc+=now()-startTs;
    cancelAnimationFrame(raf);
    status.textContent='Paused'; startBtn.textContent='Start';
  }
  function reset(){
    running=false; startTs=0; acc=0; laps=[];
    cancelAnimationFrame(raf);
    status.textContent='Ready'; startBtn.textContent='Start';
    paint(0);
  }
  function mark(){ laps.push(curSec()); }

  function paint(force=null){
    const t = thresholds();
    const s = force!==null ? force : curSec();
    digits.textContent = toMMSS(s);
    let bg='transparent';
    if(!Number.isNaN(t.g) && !Number.isNaN(t.y) && !Number.isNaN(t.r)){
      if(s>=t.r) bg='var(--red)';
      else if(s>=t.y) bg='var(--yellow)';
      else if(s>=t.g) bg='var(--green)';
    }
    square.style.backgroundColor = bg;
  }
  function tick(){ paint(); raf=requestAnimationFrame(tick); }

  function isQualified(sec){
    const t = thresholds();
    const lower = Math.max(0, t.g - 30);
    const upper = t.r + 30;
    return sec >= lower && sec <= upper;
  }

  const records = [];
  function addRecord(){
    const code = presetEl.value;
    const name = (speakerEl.value||'').trim();
    const type = PRESETS[code]?.label || 'Speech';
    const seconds = curSec();
    const mmss = toMMSS(seconds);
    const q = isQualified(seconds);
    const row = {name,type,mmss,qualified:q};
    records.push(row);
    renderRecords();
    speakerEl.value='';
    updateStartEnabled();
  }

  function renderRecords(){
    recordsTbody.innerHTML='';
    records.forEach((r,i)=>{
      const tr=document.createElement('tr');
      const qClass = r.qualified ? 'q-yes' : 'q-no';
      const qText  = r.qualified ? 'Qualified' : 'Not Qualified';
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${r.name||'-'}</td>
        <td>${r.type}</td>
        <td>${r.mmss}</td>
        <td><span class="q-badge ${qClass}" data-idx="${i}">${qText}</span></td>
      `;
      recordsTbody.appendChild(tr);
    });
  }
  recordsTbody.addEventListener('click', (e)=>{
    const el = e.target.closest('.q-badge'); if(!el) return;
    const idx = +el.dataset.idx; if(isNaN(idx)) return;
    records[idx].qualified = !records[idx].qualified;
    renderRecords();
  });

  function validateTimes(isCustom){
    errDiv.style.display='none'; errDiv.textContent='';
    if(!isCustom){ return true; }
    const g = toSec(gEl.value), y = toSec(yEl.value), r = toSec(rEl.value);
    if([g,y,r].some(v=>Number.isNaN(v))){ err('Please enter times as mm:ss (e.g., 04:00).'); return false; }
    if(g < 60){ err('Green must be at least 01:00.'); return false; }
    if(y <= g + 30){ err('Yellow must be more than 30 seconds after Green.'); return false; }
    if(r <= y + 30){ err('Red must be more than 30 seconds after Yellow.'); return false; }
    updateQualWindow();
    savePrefs();
    return true;
  }
  function err(msg){
    errDiv.textContent = msg;
    errDiv.style.display='block';
  }

  presetEl.addEventListener('change', e=>applyPreset(e.target.value));
  ['input','change','blur'].forEach(ev=>{
    gEl.addEventListener(ev, ()=>{ if(presetEl.value==='CUST'){ validateTimes(true); updateStartEnabled(); paint(); }});
    yEl.addEventListener(ev, ()=>{ if(presetEl.value==='CUST'){ validateTimes(true); updateStartEnabled(); paint(); }});
    rEl.addEventListener(ev, ()=>{ if(presetEl.value==='CUST'){ validateTimes(true); updateStartEnabled(); paint(); }});
  });

  document.getElementById('start').addEventListener('click', startOrPause);
  document.getElementById('reset').addEventListener('click', reset);
  document.getElementById('mark').addEventListener('click', mark);
  document.getElementById('addRecord').addEventListener('click', addRecord);
  document.getElementById('btn-print').addEventListener('click', () => {
    // set print meta values based on inputs
    pClub.textContent = clubNoEl.value || '4039';
    // Use provided date or today's date; display as short form (e.g., Sept 07)
    const iso = dateEl.value || todayISO();
    pDate.textContent = fmtShort(iso);
    window.print();
  });
  speakerEl.addEventListener('input', updateStartEnabled);

  // Club number: restrict to digits and 11 char max
  clubNoEl.addEventListener('input', () => {
    const digits = (clubNoEl.value||'').replace(/\D/g,'').slice(0,11);
    clubNoEl.value = digits;
    savePrefs();
  });
  // Meeting date: initialize, hint update, auto open picker on focus
  if(!dateEl.value){ dateEl.value = todayISO(); }
  function updateDateHint(){
    const hint = fmtShort(dateEl.value);
    dateHint.textContent = hint ? '(' + hint + ')' : '';
  }
  dateEl.addEventListener('change', () => { updateDateHint(); savePrefs(); });
  dateEl.addEventListener('focus', () => { try{ if(dateEl.showPicker) dateEl.showPicker(); }catch(e){} });
  updateDateHint();

  function isTypingTarget(ev){
    const t = ev.target;
    return t && (t.tagName==='INPUT' || t.tagName==='SELECT' || t.tagName==='TEXTAREA' || t.isContentEditable);
  }
  function isSpaceKey(e){
    const k = (e.key||'').toLowerCase();
    return e.code === 'Space' || k === ' ' || k === 'spacebar';
  }
  function onKey(e){
    if(isTypingTarget(e)) return;
    if(isSpaceKey(e)){
      e.preventDefault();
      startOrPause();
      return;
    }
    const k = (e.key||'').toLowerCase();
    if(k==='r'){ reset(); }
    else if(k==='f'){ try{ if(!document.fullscreenElement){ document.documentElement.requestFullscreen?.(); } else { document.exitFullscreen?.(); } }catch(_){} }
    else if(['1','2','3','4','5'].includes(k)){
      const map = { '1':'TT', '2':'EV', '3':'IB', '4':'S57', '5':'CUST' };
      presetEl.value = map[k]; applyPreset(map[k]);
    }
  }
  document.addEventListener('keydown', onKey, true);
  window.addEventListener('keydown', onKey, true);

  loadPrefs();
  updateStartEnabled();
  reset();
})();
</script>
</body>
</html>
